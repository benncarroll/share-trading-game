var beenBefore=false;var cash=5000;var portfolioWorth=0;var oohCheckDone=false;var outOfHours=false;var initialDataLoaded=false;var loadingAttempts=0;var newLoopStarted=false;var timeStarted=Date.now();var chartRendered=false;function checkUser(){if(localStorage.getItem("beenBefore")===null){setTimeout(function(){summonModal("Welcome!","Welcome to Ben's Share Trading game! <br><br> Your goal in this game, well, isn't it obvious already? No? Ok. You have to get as rich as possible as quickly as possible. Simple? Simple. Have fun!")},750);localStorage.setItem("beenBefore",true);saveUserData()}else{if(localStorage.getItem("beenBefore")){loadUserData()}}}function tradeShares(c,b,a){didErr=false;quantity=0;if(Math.floor(b)==b&&$.isNumeric(b)){if(c in stockData){b=Math.abs(b);if(a=="buy"){quantity=Math.min(b,Math.floor(cash/stockData[c]["price"]));cost=Number(stockData[c]["price"]*quantity).toFixed(2);stockData[c]["ownedQuantity"]+=quantity;cash=Number(cash);cash-=cost;cash=cash.toFixed(2)}else{if(a=="sell"){quantity=Math.min(b,stockData[c]["ownedQuantity"]);repayment=(stockData[c]["price"]*quantity).toFixed(2);stockData[c]["ownedQuantity"]-=quantity;cash=Number(cash);cash+=Number(repayment);cash=cash.toFixed(2)}}}else{doLog("tradeShares error - stock doesn't exist");didErr=true}}else{doLog("tradeShares error - amount isnt integer");didErr=true}if(didErr){doLog("TRADE FAIL    - "+actionName+" - "+stockName+" - "+quantity)}else{doLog("TRADE SUCCESS - "+actionName+" - "+stockName+" - "+quantity)}populateStockTable()}$(document).ready(function(){$("#stockInfoInsertPoint").on("click",".buySellButton",function(a){btn=$(a.currentTarget);stockName=btn.attr("data-stock");actionName=btn.attr("data-type");textArea=$("[data-stock="+stockName+"][data-type="+actionName+"Qty]");tradeShares(stockName,textArea.val(),actionName);textArea.empty()});$("#stockInfoInsertPoint").on("keypress",".buySell",function(a){if(a.which==13){textArea=$(a.currentTarget);stockName=textArea.attr("data-stock");actionName=textArea.attr("data-type2");tradeShares(stockName,Number(textArea.val()),actionName);textArea.empty()}});$(document).ajaxError(function(c,d,a,b){if(a.url=="ajax/missing.html"){$("div.log").text("Triggered ajaxError handler.")}})});var mainLoopTime=5000;var starterLoopTime=500;var lastCheck=Date.now()-60000;var starterLoop=setInterval(main,starterLoopTime);function main(){if(chartRendered){if(initialDataLoaded){updateChart();saveUserData()}currentHours=new Date().getHours();currentDay=new Date().getDay();if(currentHours>=16||currentHours<10){outOfHours=true}else{if(currentDay==0||currentDay==6){outOfHours=true}else{outOfHours=false;oohCheckDone=false}}if(!outOfHours){$("#marketStatusIndicator").text("MARKET OPEN");$("#marketStatusIndicator")[0].style.background="green"}else{$("#marketStatusIndicator").text("MARKET CLOSED");$("#marketStatusIndicator")[0].style.background="red"}if(Date.now()-lastCheck>=59000){if(!outOfHours||!oohCheckDone){oohString="";if(outOfHours){oohString=" - OUT OF HRS"}doLog("Refreshing data."+oohString);$("#dataFetchStatus").html("Fetching <i class='fas fa-circle-notch fa-spin'></i>");if(loadingAttempts==0){$("#loading-reason").text("Fetching stocks data...")}loadNewAlphaData();lastCheck=Date.now()}else{doLog("Not refreshing data - out of hours.");lastCheck=Date.now()}if(outOfHours){oohCheckDone=true}}if(dataUpdates>=Object.keys(stockData).length){dataUpdates=0;doLog("Data refresh completed.");$("#loading-reason").text("Done!");setTimeout(function(){$("#loading").fadeOut()},1000);initialDataLoaded=true;loadingAttempts=0;populateStockTable();$("#dataFetchStatus").html("Latest Data <i class='fas fa-check'></i>");setTimeout(function(){nextCheckTime=new Date(lastCheck+60000);if(!outOfHours){nextCheck=("0"+nextCheckTime.getHours()).slice(-2)+":"+("0"+nextCheckTime.getMinutes()).slice(-2)+":"+("0"+nextCheckTime.getSeconds()).slice(-2)}else{nextCheck="10:00:00"}$("#dataFetchStatus").html("Next check at "+nextCheck)},3000);priceColArray=$(".price-column");for(var a in priceColArray){if(priceColArray.hasOwnProperty(a)){$(a).addClass("flash")}}setTimeout(function(){for(var b in priceColArray){if(priceColArray.hasOwnProperty(b)){$(b).removeClass("flash")}}},1000)}}if(!initialDataLoaded){if(Date.now()-lastCheck>=10000){if(dataUpdates!=8){loadingAttempts++;doLog("Data fetch error #"+loadingAttempts+" - Retrying...");oohCheckDone=false;lastCheck-=60000;if(loadingAttempts>4){$("#loading-reason").html("Something seems to be broken.<br>Try again later.")}else{if(loadingAttempts>2){$("#loading-reason").text("This seems to be taking longer than usual...")}}}}}if(initialDataLoaded&&!newLoopStarted){doLog("All data loaded.");updateChart(dataLength,true);clearInterval(starterLoop);newLoopStarted=true;setInterval(main,mainLoopTime)}};